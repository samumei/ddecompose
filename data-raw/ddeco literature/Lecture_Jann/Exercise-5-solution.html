<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="format-detection" content="telephone=no">
<title>Exercise-5-solution.html</title>
<style>
html { -webkit-text-size-adjust: 100%; }
body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 14px; line-height: 1.428;
  max-width: 800px;
  margin: 0 auto; padding: 0 15px;
}
h1, h2, h3, h4, h5, h6 { margin: 20px 0 10px; }
h1 { font-size: 28px; } h2 { font-size: 24px; }
h3 { font-size: 18px; } h4 { font-size: 16px; }
h5 { font-size: 14px; } h6 { font-size: 12px; }
a { color: #337AB7; text-decoration: none; }
a:hover { text-decoration: underline; }
img { max-width: 100%; height: auto; }
ul, ol { padding-left: 30px; }
pre, code, samp {
  font-size: 13px;
  font-family: Courier, monospace;
}
code, samp {
  background-color: #F5F5F5;
  border-radius: 3px; padding: 3px;
}
pre code, pre samp {
  white-space: pre; background: transparent;
  border: none; padding: 0;
}
pre {
  line-height: 1.33; background-color: #F5F5F5;
  border: 1px solid #CCCCCC; border-radius: 3px;
  padding: 8px; overflow: auto;
}
</style>
<style>
.stlog { }
.stres { }
.stinp { }
.stcmd .stcmt { font-style: italic; opacity: 0.5; }
.stlog .stcmt { font-style: italic; opacity: 0.5; }
.stoom, .stcnp { font-style: italic; }
@media screen { .stcnp { display: none; }}
</style>
</head>
<body>
<style>pre {max-height:500px}</style>
    <h1>Decomposition Methods in the Social Sciences<h1>
    <h1>Solutions to Exercise 5</h1>

    <p><b>
        Ben Jann, University of Bern, December 16, 2019
    </b></p>
<p>
    Data preparation:
</p>
<pre id="stlog-1" class="stlog"><samp><span class="stinp">. use gsoep29, clear</span>
(BCPGEN: Nov 12, 2013 17:15:52-251 DBV29)

<span class="stinp">. <span class="stcmt">// selection</span></span>
<span class="stinp">. generate age = 2012 - bcgeburt</span>

<span class="stinp">. keep if inrange(age, 25, 55)</span>
(10,780 observations deleted)

<span class="stinp">. <span class="stcmt">// compute gross wages and ln(wage)</span></span>
<span class="stinp">. generate wage = labgro12 / (bctatzeit * 4.3) if labgro12&gt;0 &amp; bctatzeit&gt;0</span>
(1,936 missing values generated)

<span class="stinp">. generate lnwage = ln(wage)</span>
(1,936 missing values generated)

<span class="stinp">. <span class="stcmt">// X variables</span></span>
<span class="stinp">. generate schooling = bcbilzeit if bcbilzeit&gt;0</span>
(318 missing values generated)

<span class="stinp">. generate ft_experience = expft12 if expft12&gt;=0 </span>
(15 missing values generated)

<span class="stinp">. generate ft_experience2 = expft12^2 if expft12&gt;=0</span>
(15 missing values generated)

<span class="stinp">. <span class="stcmt">// group variable</span></span>
<span class="stinp">. generate byte female = bcsex==2 if bcsex&lt;.</span>

<span class="stinp">. <span class="stcmt">// summarize</span></span>
<span class="stinp">. summarize wage lnwage schooling ft_experience ft_experience2 female</span>

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        wage |<span class="stres">      8,090    16.26903    15.21083   .3624283   914.7287</span>
      lnwage |<span class="stres">      8,090    2.615219    .5944705  -1.014929   6.818627</span>
   schooling |<span class="stres">      9,708    12.76118     2.73677          7         18</span>
ft_experie~e |<span class="stres">     10,011    13.41052    10.03473          0         39</span>
ft_experie~2 |<span class="stres">     10,011    280.5277    324.8873          0       1521</span>
-------------+---------------------------------------------------------
      female |<span class="stres">     10,026    .5398963    .4984306          0          1</span>
</samp></pre>
<p>
    Remove observations with missing values (so that we do not have to bother about missings
    in the code below):
</p>
<pre id="stlog-2" class="stlog"><samp><span class="stinp">. drop if missing(lnwage,schooling,ft_experience,female)</span>
(2,166 observations deleted)
</samp></pre>
<p><b>
    1. On the slides there is an example where <code>oaxaca_rif</code> is used to 
    compute a reweighted RIF decomposition for the 10% quantile (Slide 35). Try
    to replicate the results “manually” by first computing the RIF and then
    applying <code>oaxaca</code> (hint: you will need two calls to <code>oaxaca</code> 
    and can then piece the results together; also see 
    Firpo et al. 2018 p. 29/30).
</b></p>
<p>
    Step 1: Compute the RIF for the 10% quantile
</p>
<pre id="stlog-3" class="stlog"><samp><span class="stinp">. egen RIF = rifvar(lnwage), q(10) by(female)</span>

<span class="stinp">. bysort female: summarize RIF</span>

------------------------------------------------------------------------------------------
-&gt; female = 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         RIF |<span class="stres">      3,877    2.086449    1.096577  -1.206162   2.451561</span>

------------------------------------------------------------------------------------------
-&gt; female = 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         RIF |<span class="stres">      3,983    1.837762    1.065745   -1.42454   2.185837</span>

</samp></pre>
<p>
    The averages of the RIF by gender are the same as reported by <code>oaxaca_rif</code> 
    on slide 35 (see <code>Overall:Group_1</code> and <code>Overall:Group_2</code>). (Apart from
    a small rounding difference for females.)
</p>
<p>
    Step 2: Compute the balancing weights (using <code>kmatch</code> for sake of brevity) and 
    compute the reweighted RIF for males
</p>
<pre id="stlog-4" class="stlog"><samp><span class="stinp">. kmatch ipw female c.schooling##c.ft_experience##c.ft_experience, att wgen(IPW)</span>
<span class="stoom">(output omitted)</span>

<span class="stinp">. egen wRIF = rifvar(lnwage) if female==0, q(10) weight(IPW)</span>
(3983 missing values generated)

<span class="stinp">. summarize wRIF [aw=IPW]</span>

    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
-------------+-----------------------------------------------------------------
        wRIF |<span class="stres">   3,877        3983    1.811982   1.426615  -2.467412   2.287448</span>
</samp></pre>
<p>
    The reweighted result for males is the same as reported by <code>oaxaca_rif</code> 
    (<code>Overall:Group_c</code>).
</p>
<p>
    Step 3: Obtain the pure explained part and the specification error by running a
    decomposition between males and reweighted males. To do so, the observations for 
    males are temporarily duplicated using <code>expand</code>.
</p>
<pre id="stlog-5" class="stlog"><samp><span class="stinp">. preserve</span>

<span class="stinp">. generate ID = _n        <span class="stcmt">// add a unique ID for each observation</span></span>

<span class="stinp">. expand 2 if female==0   <span class="stcmt">// duplicate each male observation</span></span>
(3,877 observations created)

<span class="stinp">. sort ID</span>

<span class="stinp">. by ID: gen byte C = (_n==2) if female==0 <span class="stcmt">// tag the duplicates</span></span>
(3,983 missing values generated)

<span class="stinp">. replace IPW = 1    if C==0 <span class="stcmt">// set weights to 1 for original observations</span></span>
(3,877 real changes made)

<span class="stinp">. replace RIF = wRIF if C==1 <span class="stcmt">// set RIF to reweighted RIF for duplicates</span></span>
(3,877 real changes made)

<span class="stinp">. oaxaca RIF schooling (experience: ft_experience ft_experience2) [pw=IPW], by(C) weight(1
&gt; ) cluster(ID)</span>

Blinder-Oaxaca decomposition                    Number of obs     = <span class="stres">     7,754</span>
                                                  Model           =     <span class="stres">linear</span>
Group 1: C = <span class="stres">0</span>                                    N of obs 1      = <span class="stres">      3877</span>
Group 2: C = <span class="stres">1</span>                                    N of obs 2      = <span class="stres">      3877</span>

                                 (Std. Err. adjusted for <span class="stres">3,877</span> clusters in ID)
------------------------------------------------------------------------------
             |               Robust
         RIF |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">overall      </span>|
     group_1 |<span class="stres">   2.086449   .0176113   118.47   0.000     2.051932    2.120967</span>
     group_2 |<span class="stres">   1.811982   .0397989    45.53   0.000     1.733978    1.889987</span>
  difference |<span class="stres">   .2744669   .0347395     7.90   0.000     .2063787     .342555</span>
   explained |<span class="stres">   .2310962   .0199722    11.57   0.000     .1919513    .2702411</span>
 unexplained |<span class="stres">   .0433707    .030354     1.43   0.153    -.0161221    .1028635</span>
-------------+----------------------------------------------------------------
<span class="stres">explained    </span>|
   schooling |<span class="stres">  -.0050829   .0030659    -1.66   0.097    -.0110919    .0009261</span>
  experience |<span class="stres">   .2361791   .0196051    12.05   0.000     .1977538    .2746044</span>
-------------+----------------------------------------------------------------
<span class="stres">unexplained  </span>|
   schooling |<span class="stres">  -.3566061   .1637384    -2.18   0.029    -.6775273   -.0356848</span>
  experience |<span class="stres">  -.1669017   .0758806    -2.20   0.028    -.3156249   -.0181784</span>
       _cons |<span class="stres">   .5668784   .2380854     2.38   0.017     .1002396    1.033517</span>
------------------------------------------------------------------------------
experience: ft_experience ft_experience2

<span class="stinp">. restore</span>
</samp></pre>
<p>
    The point estimates are the same as reported by <code>oaxaca_rif</code> (apart from
    some rounding imprecisions). The 
    values in panel <code>explained</code> correspond to the values in panel <code>Pure_explained</code>
    in the output of <code>oaxaca_rif</code>; the 
    values in panel <code>unexplained</code> correspond to the values in panel <code>Specif_err</code>
    in the output of <code>oaxaca_rif</code>. Furthermore, <code>overall:difference</code> corresponds to 
    <code>Explained:Total</code>, <code>overall:explained</code> corresponds to 
    <code>Explained:Pure_explained</code>, and <code>overall:unexplained</code> corresponds to 
    <code>Explained:Specif_err</code>. The standard errors are slightly different from the ones reported by 
    <code>oaxaca_rif</code>, but this should not bother us since they may not be reliably anyhow, 
    in both cases, because they ignore that the weights have been estimated (better would be to obtain 
    the standard errors using the bootstrap).
</p>
<p>
    Step 4: Obtain the pure unexplained part and the reweighting error by running a
    decomposition between reweighted males and females.
</p>
<pre id="stlog-6" class="stlog"><samp><span class="stinp">. replace wRIF = RIF if female==1 <span class="stcmt">// fill in wRIF for females</span></span>
(3,983 real changes made)

<span class="stinp">. oaxaca wRIF schooling (experience: ft_experience ft_experience2) [pw=IPW], by(female) we
&gt; ight(1)</span>

Blinder-Oaxaca decomposition                    Number of obs     = <span class="stres">     7,860</span>
                                                  Model           =     <span class="stres">linear</span>
Group 1: female = <span class="stres">0</span>                               N of obs 1      = <span class="stres">      3877</span>
Group 2: female = <span class="stres">1</span>                               N of obs 2      = <span class="stres">      3983</span>

------------------------------------------------------------------------------
             |               Robust
        wRIF |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">overall      </span>|
     group_1 |<span class="stres">   1.811982   .0398127    45.51   0.000     1.733951    1.890014</span>
     group_2 |<span class="stres">   1.837762   .0168929   108.79   0.000     1.804652    1.870871</span>
  difference |<span class="stres">  -.0257792   .0432483    -0.60   0.551    -.1105444     .058986</span>
   explained |<span class="stres">  -.0261005   .0150499    -1.73   0.083    -.0555978    .0033968</span>
 unexplained |<span class="stres">   .0003214   .0387396     0.01   0.993    -.0756068    .0762495</span>
-------------+----------------------------------------------------------------
<span class="stres">explained    </span>|
   schooling |<span class="stres">  -.0018931   .0076058    -0.25   0.803    -.0168001     .013014</span>
  experience |<span class="stres">  -.0242074   .0122183    -1.98   0.048    -.0481548   -.0002601</span>
-------------+----------------------------------------------------------------
<span class="stres">unexplained  </span>|
   schooling |<span class="stres">   .5277574   .2060428     2.56   0.010      .123921    .9315938</span>
  experience |<span class="stres">   .3637291    .102473     3.55   0.000     .1628857    .5645725</span>
       _cons |<span class="stres">  -.8911651   .3023822    -2.95   0.003    -1.483823    -.298507</span>
------------------------------------------------------------------------------
experience: ft_experience ft_experience2
</samp></pre>
<p>
    The results are again very similar to the ones reported by <code>oaxaca_rif</code>
    (the relevant panels in the output by <code>oaxaca_rif</code> are <code>Unexplained</code>,
    <code>Pure_Unexplained</code>, and <code>Reweight_err</code>), but the differences
    are somewhat larger than for the explained part above. Nonetheless, it seems
    that also these differences are caused by rounding imprecisions. (I played around a bit
    with using different storage types for the generated variables, and depending on 
    variant, some of the results can be replicated exactly. However, I did not find 
    a combination that perfectly replicates all results at the same time.)
</p>
<p><b>
    2. Try to improve the analysis by using entropy balancing for the
    reweighting (such that the reweighting error becomes zero). How do the 
    results change?
</b></p>
<p>
    Redo step 2 using entropy balancing: 
</p>
<pre id="stlog-7" class="stlog"><samp><span class="stinp">. drop IPW wRIF</span>

<span class="stinp">. kmatch eb female c.schooling##c.ft_experience##c.ft_experience, att wgen(IPW)</span>
<span class="stoom">(output omitted)</span>

<span class="stinp">. egen wRIF = rifvar(lnwage) if female==0, q(10) weight(IPW)</span>
(3983 missing values generated)

<span class="stinp">. summarize wRIF [aw=IPW]</span>

    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
-------------+-----------------------------------------------------------------
        wRIF |<span class="stres">   3,877        3983    1.844498   1.367399  -2.257941   2.300153</span>
</samp></pre>
<p>
    Step 3: Obtain the pure explained part and the specification error
</p>
<pre id="stlog-8" class="stlog"><samp><span class="stinp">. preserve</span>

<span class="stinp">. generate ID = _n        <span class="stcmt">// add a unique ID for each observation</span></span>

<span class="stinp">. expand 2 if female==0   <span class="stcmt">// duplicate each male observation</span></span>
(3,877 observations created)

<span class="stinp">. sort ID</span>

<span class="stinp">. by ID: gen byte C = (_n==2) if female==0 <span class="stcmt">// tag the duplicates</span></span>
(3,983 missing values generated)

<span class="stinp">. replace IPW = 1    if C==0 <span class="stcmt">// set weights to 1 for original observations</span></span>
(3,877 real changes made)

<span class="stinp">. replace RIF = wRIF if C==1 <span class="stcmt">// set RIF to reweighted RIF for duplicates</span></span>
(3,877 real changes made)

<span class="stinp">. oaxaca RIF schooling (experience: ft_experience ft_experience2) [pw=IPW], by(C) weight(1
&gt; ) cluster(ID)</span>

Blinder-Oaxaca decomposition                    Number of obs     = <span class="stres">     7,754</span>
                                                  Model           =     <span class="stres">linear</span>
Group 1: C = <span class="stres">0</span>                                    N of obs 1      = <span class="stres">      3877</span>
Group 2: C = <span class="stres">1</span>                                    N of obs 2      = <span class="stres">      3877</span>

                                 (Std. Err. adjusted for <span class="stres">3,877</span> clusters in ID)
------------------------------------------------------------------------------
             |               Robust
         RIF |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">overall      </span>|
     group_1 |<span class="stres">   2.086449   .0176113   118.47   0.000     2.051932    2.120967</span>
     group_2 |<span class="stres">   1.844498   .0358116    51.51   0.000     1.774309    1.914688</span>
  difference |<span class="stres">   .2419512   .0303389     7.97   0.000     .1824882    .3014143</span>
   explained |<span class="stres">   .2131434    .018312    11.64   0.000     .1772526    .2490342</span>
 unexplained |<span class="stres">   .0288078   .0264325     1.09   0.276    -.0229989    .0806146</span>
-------------+----------------------------------------------------------------
<span class="stres">explained    </span>|
   schooling |<span class="stres">  -.0064603   .0028117    -2.30   0.022    -.0119712   -.0009494</span>
  experience |<span class="stres">   .2196037    .018062    12.16   0.000     .1842028    .2550045</span>
-------------+----------------------------------------------------------------
<span class="stres">unexplained  </span>|
   schooling |<span class="stres">  -.2286504   .1416979    -1.61   0.107    -.5063732    .0490723</span>
  experience |<span class="stres">  -.1539027   .0711918    -2.16   0.031    -.2934361   -.0143693</span>
       _cons |<span class="stres">    .411361   .2092814     1.97   0.049     .0011769     .821545</span>
------------------------------------------------------------------------------
experience: ft_experience ft_experience2

<span class="stinp">. restore</span>
</samp></pre>
<p>
    Step 3: Obtain the pure unexplained part and the reweighting error
</p>
<pre id="stlog-9" class="stlog"><samp><span class="stinp">. replace wRIF = RIF if female==1 <span class="stcmt">// fill in wRIF for females</span></span>
(3,983 real changes made)

<span class="stinp">. oaxaca wRIF schooling (experience: ft_experience ft_experience2) [pw=IPW], by(female) we
&gt; ight(1)</span>

Blinder-Oaxaca decomposition                    Number of obs     = <span class="stres">     7,860</span>
                                                  Model           =     <span class="stres">linear</span>
Group 1: female = <span class="stres">0</span>                               N of obs 1      = <span class="stres">      3877</span>
Group 2: female = <span class="stres">1</span>                               N of obs 2      = <span class="stres">      3983</span>

------------------------------------------------------------------------------
             |               Robust
        wRIF |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">overall      </span>|
     group_1 |<span class="stres">   1.844498   .0358241    51.49   0.000     1.774284    1.914712</span>
     group_2 |<span class="stres">   1.837762   .0168929   108.79   0.000     1.804652    1.870871</span>
  difference |<span class="stres">   .0067365   .0396072     0.17   0.865    -.0708923    .0843653</span>
   explained |<span class="stres">  -1.73e-10   .0132231    -0.00   1.000    -.0259168    .0259168</span>
 unexplained |<span class="stres">   .0067365   .0378671     0.18   0.859    -.0674817    .0809547</span>
-------------+----------------------------------------------------------------
<span class="stres">explained    </span>|
   schooling |<span class="stres">   1.62e-16   .0066747     0.00   1.000    -.0130821    .0130821</span>
  experience |<span class="stres">  -1.73e-10   .0108832    -0.00   1.000    -.0213307    .0213307</span>
-------------+----------------------------------------------------------------
<span class="stres">unexplained  </span>|
   schooling |<span class="stres">   .3992861   .1874837     2.13   0.033     .0318247    .7667474</span>
  experience |<span class="stres">   .3430981   .0967126     3.55   0.000      .153545    .5326512</span>
       _cons |<span class="stres">  -.7356477    .276557    -2.66   0.008    -1.277689   -.1936059</span>
------------------------------------------------------------------------------
experience: ft_experience ft_experience2
</samp></pre>
<p>
    We see how the reweighting error is pushed to zero. Overall, these results suggest that 
    the 10% quantile wage gap between males and females is fully explained and that the unexplained 
    part is essentially zero. The main driver of the 10% quantile wage gap is the difference in work experience.
</p>
</body>
</html>
