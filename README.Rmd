---
output:
  github_document:
    toc: true
    toc_depth: 3
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# `ddeco`: Detailed decompositions of between-group differences

## Overview

**ddeco** implements the [Oaxaca (1973)](https://www.jstor.org/stable/2525981)-[Blinder (1973)](https://www.jstor.org/stable/144855) decomposition method and 
generalizations of it that allow to decompose differences between two groups
in a distributional statistics beyond the mean. `ob_deco()` divides an observed
difference in the mean into (wage) structure effects and composition effects
that can be attributed to single covariates. For other distributional statistics, 
the function peforms the RIF decomposition proposed by [Firpo, Fortin, 
and Lemieux (2018)]( https://doi.org/10.3390/econometrics6020028). `dfl_deco()` divides differences in an aggregate wage
structure effect and composition effect using the reweighting estimator of [DiNardo, 
Fortin, and Lemieux (1996)](https://www.jstor.org/stable/2171954). The function also allows to sequentially decompose
the composition effect into the contribtuion of single covariates.

## Installation 

You can either install the CRAN version of `ddeco`
```{r, eval=FALSE}
install.packages("ddeco")
```

or the latest development version from GitHub:
```{r , eval=FALSE}
devtools::install_github("samumei/ddeco")
```


## Background

The **ddeco** package allows to decompose observed differences in a distributional
statistics $\nu_t=\nu(F_{Y_t})$ of an outcome variable $Y_t$ (e.g., hourly wages) between 
two groups $t = 0,1$.
$$\Delta_O^{\nu} = \nu_1 - \nu_0.$$
We are interested to what extent the difference can explained by a different composition
of observable covariates and by differences in structure linking covariates to the 
outcome variables. For this purpose, we define a conterfactual outcome statistic that
would be observed if group 0 had the same composition like group 1 but otherwise
the same structure linking covariates to the outcome variable. By contrasting 
the observed statistics to the counterfactual, we can indentify the composition 
effect $\Delta_S^\nu$ and the (wage) structure effect $\Delta_X^\nu$  that capture 
differencs in the structure linking covariates to the outcome and in the difference
in the composition of covariates, respectively: 
$$\Delta_O^{\nu} = (\nu_1 - \nu_C) + (\nu_C - \nu_0) = \Delta_S^\nu + \Delta_X^\nu.$$
Note, we could specifiy the counterfactual the other way round.

Under certain assumptions (see Firpo, Fortin, and Lemieux, 2011)
(ignorability/CIA, overlapping support), we can derive...

Standard OB case.
...


## Reweighting decompositions with `dfl_deco()`

### Aggregate decomposition

`dfl_deco()` uses inverse probability weighting to estimate counterfactual 
distributional statistics. The counterfactual combines the conditional outcome
distribution of the reference group, here defined as group 0, with the covariates 
distribution of the comparison group, and can expressed as reweighted version of the
reference distribution
$$F_{Y_C}(y) = \int F_{Y_0}(y|x)dF_{X_1} (x)= \int F_{Y_0}(y|x)\Psi(x)dF_{X_0}(x),$$

where the reweighting factor $\Psi(x) = \frac{P(t=0)P(t=1|X)}{P(t=1)P(t=0|X)}$ 
captures the inverse probability of belonging to group 1. The reweighting factor
can be written as function of the probabilities of the binary group 
variable $t$ and can, thus, readily estimated in the pooled sample of the two
group unsing conditional probability models. The counterfactual statistics are
then estimated with weighted estimator using the observed data of group 0 and 
the fitted reweighting factors.

### Sequential decomposition

We can extend the the reweighting approach to sequentially decompose the composition
effect into the contribution of single covariates $X$ and $Z$, respectively 
$$\Delta_X^{\nu} =  (\nu_C - \nu_{C,X}) + (\nu_{C,X} - \nu_0) = \Delta_{X,X}^\nu + \Delta_{X,Z}^\nu,$$

where we define $\nu_C$ as the statistic of the counterfactual where we combine the 
conditional outcome of group 0 with the covariates distribution of group 1, i.e.
$$F_{Y_{C}}(y) = \iint F_{Y_0}(y|x,z)dF_{X_1}(x|z)dF_{Z_1}(x).$$

For the decomposition work, we require an additional counterfactual $\nu_{C,X}$ that 
combines the conditional outcome distribution of group 0 and the distribution of covariate $X$ given $Z$ of the same group with the marginal distribution of $Z$ of group 1, i.e.
$$F_{Y_{C,X}}(y) = \iint F_{Y_0}(y|x,z)dF_{X_0}(x|z)dF_{Z_1}(x).$$
Note, sequential decompositions are path-dependent, i.e. the detailed composition
effects attributed to single covariates depend on the order we include the 
variables into the sequence (i.e. if we integrate over the conditional distribution
of $X$ or that of $Z$, respecitvely). Moreover, we get different results if we 
derive $\nu_{C,X}$ using the conditional covariate distribution from the other group, e.g.
$$F_{Y_{C,X}}(y) = \iint F_{Y_0}(y|x,z)dF_{X_1}(x|z)dF_{Z_0}(x).$$


### Example

Fortin, Lemieux, and Firpo (FLF, 2011, p. 79-88) decompose the increase in US 
male wage inequality between the early 1980s and the early 2000s using the CPS
data. In this example, we replicate their results and treat the observations from
1983 to 1985 as reference group that is reweighted.

```{r}
library(ddeco)
data("men8305")
flf_model <- log(wage) ~ union*(education + experience) + education*experience
flf_male_inequality  <- dfl_deco(flf_model,
                                  data = men8305,
                                  weights = weights,
                                  group = year)
```
We can summarize the results:
```{r}
summary(flf_male_inequality)
```

Using `plot()`, we can illustrate the decomposition accross different quantiles.
```{r}
plot(flf_male_inequality)
```





## Credits

David Gallusser & Samuel Meier

## References

Cowell, Frank A., and Emmanuel Flachaire. 2007. "Income distribution and inequality measurement: The problem of extreme values." *Journal of Econometrics* 141: 1044–1072.

Essama-Nssah, Boniface, and Peter J. Lambert. 2012. “Influence Functions for Policy Impact Analysis.” In John A. Bishop and Rafael Salas, eds., *Inequality, Mobility and Segregation: Essays in Honor of Jacques Silber*. Bigley, UK: Emerald Group Publishing
Limited.

Firpo, Sergio, Nicole M. Fortin, and Thomas Lemieux. 2007a. “Unconditional Quantile Regressions.” *Tech-
nical Working Paper 339, National Bureau of Economic Research*. Cambridge, MA. 

Firpo, Sergio, Nicole M. Fortin, and Thomas Lemieux. 2009a. "Unconditional Quantile Regressions." *Econometrica* 77(3): 953-973.

Firpo, Sergio, Nicole M. Fortin, and Thomas Lemieux. 2009b. "Supplement to 'Unconditional Quantile Regressions'." *Econometrica Supplemental Material*, 77.

Rios-Avila, Fernando (2020): "Recentered influence functions (RIFs) in Stata: RIF regression and RIF decomposition." *The Stata Journal* 20(1): 51-94.

Rothe, Christoph (2015): "Decomposing the Composition Effect. The Role of Covariates in Determining Between-Group Differences in Economic Outcomes." *Journal of Business & Economic Statistics* 33(3): 323-337.

